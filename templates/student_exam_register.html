<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register for an Exam</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
    h2 { text-align: center; margin-bottom: 30px; }
    form { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input[type="date"], input[type="submit"], button {
        width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;
        border-radius: 5px; border: 1px solid #ccc;
    }
    input[type="submit"], button {
        background-color: #007bff; color: white; font-weight: bold; cursor: pointer;
        margin-top: 20px;
    }
    input[type="submit"]:hover, button:hover { background-color: #0056b3; }
    input:disabled, select:disabled { background-color: #eee; cursor: not-allowed; }
</style>
</head>
<body>

<h2>Register for an Exam</h2>

<form method="POST" action="/exam_register" id="examRegisterForm">
    <label for="examSelect">Exam:</label>
    <select id="examSelect" name="exam_id" required>
        <option value="">-- Select Exam --</option>
        {% for exam in exams %}
        <option value="{{ exam.id }}">{{ exam.name }}</option>
        {% endfor %}
    </select>

    <label for="locationSelect">Location:</label>
    <select id="locationSelect" required disabled>
        <option value="">-- Select Location --</option>
    </select>

    <label for="dateSelect">Date:</label>
    <input type="date" id="dateSelect" required disabled>

    <label for="timeSelect">Time:</label>
    <select id="timeSelect" required disabled>
        <option value="">-- Select Time --</option>
    </select>

    <input type="hidden" name="session_id" id="sessionIdInput">
    <input type="submit" value="Register" id="registerButton" disabled>
    <button type="button" onclick="window.location.href='/student_home'">Cancel</button>
</form>

<script>
    const sessions = {{ sessions | tojson }};
    const examSelect = document.getElementById('examSelect');
    const locationSelect = document.getElementById('locationSelect');
    const dateSelect = document.getElementById('dateSelect');
    const timeSelect = document.getElementById('timeSelect');
    const sessionIdInput = document.getElementById('sessionIdInput');
    const registerButton = document.getElementById('registerButton');

    let filteredSessions = [];

    examSelect.addEventListener('change', () => {
        const examId = examSelect.value;
        locationSelect.innerHTML = '<option value="">-- Select Location --</option>';
        dateSelect.value = '';
        timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
        dateSelect.disabled = true;
        timeSelect.disabled = true;
        registerButton.disabled = true;

        if (!examId) {
            locationSelect.disabled = true;
            return;
        }

        filteredSessions = sessions.filter(s => s.exam_id == examId);
        const locationIds = [...new Set(filteredSessions.map(s => s.location_id))];

        locationIds.forEach(locId => {
            const loc = filteredSessions.find(s => s.location_id == locId);
            locationSelect.innerHTML += `<option value="${loc.location_id}">${loc.campus_name} - Room ${loc.room_number}</option>`;
        });

        locationSelect.disabled = false;
    });

    locationSelect.addEventListener('change', () => {
        const locId = locationSelect.value;
        dateSelect.value = '';
        timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
        dateSelect.disabled = true;
        timeSelect.disabled = true;
        registerButton.disabled = true;

        if (!locId) return;

        const dates = [...new Set(filteredSessions
            .filter(s => s.location_id == locId)
            .map(s => s.session_date))];

        dateSelect.min = new Date().toISOString().split('T')[0];
        dateSelect.disabled = false;
        dateSelect.dataset.availableDates = JSON.stringify(dates);
    });

    dateSelect.addEventListener('change', () => {
        const locId = locationSelect.value;
        const selectedDate = dateSelect.value;
        timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
        timeSelect.disabled = true;
        registerButton.disabled = true;

        if (!selectedDate || !locId) return;

        const availableTimes = filteredSessions
            .filter(s => s.location_id == locId && s.session_date == selectedDate)
            .map(s => ({ time: s.session_time, id: s.id }));

        availableTimes.forEach(t => {
            timeSelect.innerHTML += `<option value="${t.id}">${t.time}</option>`;
        });

        if (availableTimes.length > 0) timeSelect.disabled = false;
    });

    timeSelect.addEventListener('change', () => {
        sessionIdInput.value = timeSelect.value;
        registerButton.disabled = !timeSelect.value;
    });
</script>
</body>
</html>
