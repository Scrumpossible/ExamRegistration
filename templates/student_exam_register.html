<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register for an Exam</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
    h2 { text-align: center; margin-bottom: 30px; }
    form { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input[type="date"], input[type="submit"], button {
        width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;
        border-radius: 5px; border: 1px solid #ccc;
    }
    input[type="submit"], button {
        background-color: #007bff; color: white; font-weight: bold; cursor: pointer;
        margin-top: 20px;
    }
    input[type="submit"]:hover, button:hover { background-color: #0056b3; }
    input:disabled, select:disabled { background-color: #eee; cursor: not-allowed; }
</style>
</head>
<body>

<h2>Register for an Exam</h2>

<form method="POST" action="/exam_register" id="examRegisterForm">
    <label for="examSelect">Exam:</label>
    <select id="examSelect" name="exam_id" required>
        <option value="">-- Select Exam --</option>
        {% for exam in exams %}
            {% set disabled = existing_regs | selectattr('exam_id', 'equalto', exam.id) | list %}
            <option value="{{ exam.id }}" {% if disabled %}disabled{% endif %}>
                {{ exam.name }} {% if disabled %}(Already registered){% endif %}
            </option>
        {% endfor %}
    </select>

    <label for="locationSelect">Location:</label>
    <select id="locationSelect" name="location_id" required disabled>
        <option value="">-- Select Location --</option>
        {% for loc in locations %}
            <option value="{{ loc.id }}">{{ loc.campus_name }} - Room {{ loc.room_number }}</option>
        {% endfor %}
    </select>

    <label for="dateSelect">Date:</label>
    <input type="date" id="dateSelect" name="date" required disabled>

    <label for="timeSelect">Time:</label>
    <select id="timeSelect" name="time" required disabled>
        <option value="">-- Select Time --</option>
    </select>

    <input type="hidden" name="session_id" id="sessionIdInput">

    <input type="submit" value="Register" id="registerButton" disabled>
    <button type="button" onclick="window.location.href='/student_home'">Cancel</button>
</form>

<script>
const examSelect = document.getElementById('examSelect');
const locationSelect = document.getElementById('locationSelect');
const dateSelect = document.getElementById('dateSelect');
const timeSelect = document.getElementById('timeSelect');
const sessionIdInput = document.getElementById('sessionIdInput');
const registerButton = document.getElementById('registerButton');

// Existing registrations passed from Flask
const existingRegs = {{ existing_regs | tojson }};

// Time slots 8AM-4PM
const TIME_SLOTS = [];
for (let hour = 8; hour <= 16; hour++) {
    const ampm = hour < 12 ? 'AM' : 'PM';
    const displayHour = hour % 12 === 0 ? 12 : hour % 12;
    TIME_SLOTS.push(`${displayHour}:00 ${ampm}`);
}

// Enable location select when exam is chosen
examSelect.addEventListener('change', () => {
    locationSelect.disabled = !examSelect.value;
    dateSelect.value = '';
    dateSelect.disabled = true;
    timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
    timeSelect.disabled = true;
    registerButton.disabled = true;
    sessionIdInput.value = '';
});

// Enable date select when location is chosen
locationSelect.addEventListener('change', () => {
    dateSelect.value = '';
    dateSelect.disabled = !locationSelect.value;
    timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
    timeSelect.disabled = true;
    registerButton.disabled = true;
    sessionIdInput.value = '';

    if (!locationSelect.value) return;

    const today = new Date();
    const maxDate = new Date();
    maxDate.setMonth(today.getMonth() + 3);
    dateSelect.min = today.toISOString().split('T')[0];
    dateSelect.max = maxDate.toISOString().split('T')[0];
});

// Populate times when a date is chosen
dateSelect.addEventListener('change', () => {
    timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
    registerButton.disabled = true;
    sessionIdInput.value = '';

    if (!dateSelect.value) {
        timeSelect.disabled = true;
        return;
    }

    TIME_SLOTS.forEach(slot => {
        const conflict = existingRegs.some(reg => 
            reg.session_date === dateSelect.value &&
            reg.session_time === slot24ToHHMM(slot)
        );
        timeSelect.innerHTML += `<option value="${slot}" ${conflict ? 'disabled' : ''}>
            ${slot} ${conflict ? '(Already registered)' : ''}
        </option>`;
    });
    timeSelect.disabled = false;
});

// Convert 12h slot to HH:MM
function slot24ToHHMM(slot) {
    let [hourMin, ampm] = slot.split(' ');
    let [h, m] = hourMin.split(':').map(Number);
    if (ampm === "PM" && h < 12) h += 12;
    if (ampm === "AM" && h === 12) h = 0;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
}

// Enable submit button
timeSelect.addEventListener('change', () => {
    if (!timeSelect.value) {
        registerButton.disabled = true;
        sessionIdInput.value = '';
        return;
    }
    const [hourMin, ampm] = timeSelect.value.split(' ');
    let [h, m] = hourMin.split(':').map(Number);
    if (ampm === "PM" && h < 12) h += 12;
    if (ampm === "AM" && h === 12) h = 0;
    const time24 = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;

    sessionIdInput.value = `${examSelect.value}_${locationSelect.value}_${dateSelect.value}_${time24}`;
    registerButton.disabled = false;
});

// Prevent submitting a disabled time slot
document.getElementById('examRegisterForm').addEventListener('submit', (e) => {
    const selectedTimeOption = timeSelect.options[timeSelect.selectedIndex];
    if (selectedTimeOption.disabled) {
        e.preventDefault();
        alert("You cannot register for this time slot because you are already registered for another exam at this time.");
    }
});
</script>

</body>
</html>